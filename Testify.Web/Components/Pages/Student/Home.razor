@layout StudentLayout
@page "/Student/Home"
@using Testify.DAL.ViewModels
@using Testify.Web.Components.Pages.Student.Component

@if (isLoading)
{
    <MudPaper Style="width: 100%; height: calc(100svh - 64px); display: flex; justify-content: center; align-items: center; background-color: rgba(0, 0, 0, 0.5)">
        <Testify.Web.Shared.LoadingContext />
    </MudPaper>
}
else
{
    <MudGrid Style="padding: 1%; height: calc(100vh - 64px);" Spacing="4">
        <MudItem lg="3" md="5" sm="12" xs="12" Style="height: 100%">
            <MudPaper Width="100%" Height="100%" Elevation="2" Style="padding: 5%">
                <MudGrid Justify="Justify.SpaceBetween" Spacing="1">
                    <MudItem xs="0" Style="align-content: center; align-items: center; display: flex">
                        <MudText Typo="Typo.h6" Style="font-weight: bold">Lich thi của tôi</MudText>
                    </MudItem>
                    <MudItem xs="0">
                        <MudLink Href="/ExamList">
                            <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="20" cy="20" r="20" fill="#29A69A" />
                                <g clip-path="url(#clip0_278_252)">
                                    <path d="M16.6477 18.6953H14.6602V20.683H16.6477V18.6953Z" fill="white" />
                                    <path d="M25.343 18.6953H23.3555V20.683H25.343V18.6953Z" fill="white" />
                                    <path d="M22.4446 18.6953H20.457V20.683H22.4446V18.6953Z" fill="white" />
                                    <path d="M16.6477 21.8008H14.6602V23.7885H16.6477V21.8008Z" fill="white" />
                                    <path d="M22.4446 21.8008H20.457V23.7885H22.4446V21.8008Z" fill="white" />
                                    <path d="M19.5461 21.8008H17.5586V23.7885H19.5461V21.8008Z" fill="white" />
                                    <path d="M25.343 24.9062H23.3555V26.8939H25.343V24.9062Z" fill="white" />
                                    <path d="M22.4446 24.9062H20.457V26.8939H22.4446V24.9062Z" fill="white" />
                                    <path d="M19.5461 24.9062H17.5586V26.8939H19.5461V24.9062Z" fill="white" />
                                    <path d="M27.1611 12.1504H25.5448V13.7C25.5448 14.2782 25.0685 14.7484 24.483 14.7484H22.3727C21.7872 14.7484 21.3109 14.2782 21.3109 13.7V12.1504H18.69V13.6854C18.69 14.2717 18.2084 14.7484 17.6164 14.7484H15.5295C14.9375 14.7484 14.4559 14.2717 14.4559 13.6854V12.1504H12.8397C11.7887 12.1504 10.9336 12.9977 10.9336 14.0392V28.1113C10.9336 29.1528 11.7887 30.0002 12.8397 30.0002H27.1611C28.2137 30.0002 29.0701 29.1528 29.0701 28.1113V14.0392C29.0701 12.9978 28.2137 12.1504 27.1611 12.1504ZM27.7037 28.0746C27.7037 28.409 27.479 28.6336 27.1446 28.6336H12.859C12.5246 28.6336 12.3 28.409 12.3 28.0746V16.9568H27.7037V28.0746Z" fill="white" />
                                    <path d="M15.5313 14.0042H17.617C17.7936 14.0042 17.9372 13.8615 17.9372 13.6861V10.8005C17.9372 10.3591 17.5751 10 17.13 10H16.0183C15.5732 10 15.2109 10.3591 15.2109 10.8005V13.6861C15.211 13.8615 15.3546 14.0042 15.5313 14.0042Z" fill="white" />
                                    <path d="M22.3743 14.0042H24.4846C24.6545 14.0042 24.7926 13.867 24.7926 13.6985V10.7882C24.7926 10.3536 24.4361 10 23.9977 10H22.8613C22.423 10 22.0664 10.3536 22.0664 10.7882V13.6985C22.0664 13.867 22.2045 14.0042 22.3743 14.0042Z" fill="white" />
                                </g>
                                <defs>
                                    <clipPath id="clip0_278_252">
                                        <rect width="20" height="20" fill="white" transform="translate(10 10)" />
                                    </clipPath>
                                </defs>
                            </svg>
                        </MudLink>
                    </MudItem>

                </MudGrid>
                <MudPaper Elevation="0" Style="min-height: 300px">
                    @if (_lstExam.Count <= 0 || _lstExam == null)
                    {
                        <MudText Class="w-100 p-3 text-center" Style="font-size: 14px">Chưa có bài thi nào</MudText>
                    }
                    else
                    {
                        @foreach (var item in _lstExam)
                        {
                            <MudPaper Elevation="0" Style="padding-top: 4%; padding-bottom: 4%; border-bottom: 2px dashed #D9D9D9 ">
                                <MudGrid Class="p-0 m-0 w-100" Style="align-items: center; align-content: center">
                                    <MudItem xs="3" Class="pt-0">
                                        <MudPaper Elevation="0" Class="border-none" Style="text-align: center;" Width="100%">
                                            <MudText Style="font-size: 14px; padding-left: 0">@item.ExamScheduleStartTime.ToShortDateString()</MudText>
                                            <MudText Color="Color.Secondary" Style="font-weight: bold">@item.ExamScheduleStartTime.TimeOfDay</MudText>
                                        </MudPaper>
                                    </MudItem>
                                    <MudItem xs="8" Style="font-weight: bold; display: flex;padding-left: 0; justify-content: center; padding-top: 0">
                                        @item.ExamScheduleName
                                    </MudItem>
                                    <MudItem xs="1" Style="padding-left: 0; padding-top: 0">
                                        <MudIcon Icon="@Icons.Material.Filled.ArrowOutward"></MudIcon>
                                    </MudItem>
                                </MudGrid>
                            </MudPaper>
                        }
                    }
                </MudPaper>
                <MudGrid Justify="Justify.SpaceBetween" Spacing="1" Style="margin-top:2%">
                    <MudItem xs="0" Style="align-content: center; align-items: center; display: flex">
                        <MudText Typo="Typo.h6" Style="font-weight: bold">Thành tích</MudText>
                    </MudItem>
                    <MudItem xs="0">

                    </MudItem>

                </MudGrid>
                <MudDataGrid Elevation="0" Items="@_lstAchivenment" Virtualize="true" FixedHeader="true" Height="350px">
                    <Columns>
                        <PropertyColumn Property="x => x.ClassName" Title="Lớp" />
                        <PropertyColumn Property="x => x.SubjectName" Title="Môn" />
                        <PropertyColumn Property="x => x.AvgScore" Title="Điểm" />

                    </Columns>
                </MudDataGrid>
            </MudPaper>
        </MudItem>
        <MudItem lg="9" md="7" sm="12" xs="12" Class="h-100">
            <MudGrid>
                <MudItem xs="12" lg="6" md="6" sm="12">
                    <MudPaper Class="d-flex align-center justify-center mud-width-full pa-5" Elevation="0" Style="background-color:#E7E6FB">
                        <MudGrid Style="padding:0; margin:0;">
                            <MudItem xs="4" Style="padding-top:0; padding-left:0">
                                <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20.832 60.416V54.166H27.082V60.416H20.832Z" fill="#6151FB" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M66.6654 91.6664H16.6654C12.063 91.6664 8.33203 87.9353 8.33203 83.333V16.6663C8.33203 12.064 12.063 8.33301 16.6654 8.33301H66.6654C71.2677 8.33301 74.9987 12.064 74.9987 16.6663V83.333C74.9987 87.9353 71.2677 91.6664 66.6654 91.6664ZM37.4987 27.083C37.4987 25.9324 38.4314 24.9997 39.582 24.9997H64.582C65.7327 24.9997 66.6654 25.9324 66.6654 27.083C66.6654 28.2336 65.7327 29.1663 64.582 29.1663H39.582C38.4314 29.1663 37.4987 28.2336 37.4987 27.083ZM39.582 33.333C38.4314 33.333 37.4987 34.2657 37.4987 35.4163C37.4987 36.567 38.4314 37.4997 39.582 37.4997H64.582C65.7327 37.4997 66.6654 36.567 66.6654 35.4163C66.6654 34.2657 65.7327 33.333 64.582 33.333H39.582ZM32.7218 25.6099C33.5354 26.4234 33.5354 27.7426 32.7218 28.5561L22.9154 38.3626L17.2756 32.7228C16.462 31.9093 16.462 30.5901 17.2756 29.7766C18.0892 28.963 19.4082 28.963 20.2218 29.7766L22.9154 32.4701L29.7756 25.6099C30.5891 24.7963 31.9083 24.7963 32.7218 25.6099ZM39.582 49.9997C38.4314 49.9997 37.4987 50.9324 37.4987 52.083C37.4987 53.2336 38.4314 54.1663 39.582 54.1663H64.582C65.7327 54.1663 66.6654 53.2336 66.6654 52.083C66.6654 50.9324 65.7327 49.9997 64.582 49.9997H39.582ZM37.4987 60.4163C37.4987 59.2657 38.4314 58.333 39.582 58.333H64.582C65.7327 58.333 66.6654 59.2657 66.6654 60.4163C66.6654 61.567 65.7327 62.4997 64.582 62.4997H39.582C38.4314 62.4997 37.4987 61.567 37.4987 60.4163ZM29.1654 49.9997H18.7487C17.5981 49.9997 16.6654 50.9324 16.6654 52.083V62.4997C16.6654 63.6503 17.5981 64.583 18.7487 64.583H29.1654C30.316 64.583 31.2487 63.6503 31.2487 62.4997V52.083C31.2487 50.9324 30.316 49.9997 29.1654 49.9997Z" fill="#6151FB" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M91.6641 83.333L85.4141 91.6663L79.1641 83.333V45.833H91.6641V83.333Z" fill="#6151FB" />
                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M83.3307 31.25H87.4974C89.7986 31.25 91.6641 33.1154 91.6641 35.4167V43.75H79.1641V35.4167C79.1641 33.1154 81.0295 31.25 83.3307 31.25Z" fill="#6151FB" />
                                </svg>
                            </MudItem>

                            <MudItem xs="8" Class="d-flex justify-center flex-column" Style="padding-top:0; padding-left:0; text-align:center; ">
                                <MudText Typo="Typo.h6">Tổng số bài đã thi</MudText>
                                <MudText>@_totalSubmitted</MudText>
                            </MudItem>
                        </MudGrid>

                    </MudPaper>
                </MudItem>
                <MudItem xs="12" lg="6" md="6" sm="12">
                    <MudPaper Class="d-flex align-center justify-center mud-width-full pa-5" Elevation="0" Style="background-color:#F9E5EA">
                        <MudGrid Style="padding:0; margin:0;">
                            <MudItem xs="4" Style="padding-top:0; padding-left:0">
                                <svg width="100" height="100" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M28.4705 19.1428C33.7553 19.1428 38.0412 14.857 38.0412 9.5707C38.0412 4.28418 33.7553 0 28.4705 0C23.1842 0 18.8984 4.28418 18.8984 9.5707C18.8984 14.857 23.1842 19.1428 28.4705 19.1428Z" fill="#EF2B58" />
                                    <path d="M21.5012 83.3051C26.7485 83.3051 31.0023 79.0513 31.0023 73.8039C31.0023 68.5566 26.7485 64.3027 21.5012 64.3027C16.2538 64.3027 12 68.5566 12 73.8039C12 79.0513 16.2538 83.3051 21.5012 83.3051Z" fill="#EF2B58" />
                                    <path d="M21.5467 87.931C14.9307 87.8826 9.52656 93.2044 9.47656 99.8204L33.4361 99.9995C33.4844 93.3835 28.1627 87.9812 21.5467 87.931Z" fill="#EF2B58" />
                                    <path d="M52.9426 83.3051C58.1899 83.3051 62.4437 79.0513 62.4437 73.8039C62.4437 68.5566 58.1899 64.3027 52.9426 64.3027C47.6952 64.3027 43.4414 68.5566 43.4414 73.8039C43.4414 79.0513 47.6952 83.3051 52.9426 83.3051Z" fill="#EF2B58" />
                                    <path d="M52.9867 87.931C46.3723 87.8826 40.9664 93.2044 40.918 99.8204L64.8777 99.9995C64.9262 93.3835 59.6027 87.9812 52.9867 87.931Z" fill="#EF2B58" />
                                    <path d="M84.3801 83.3051C89.6274 83.3051 93.8812 79.0513 93.8812 73.8039C93.8812 68.5566 89.6274 64.3027 84.3801 64.3027C79.1327 64.3027 74.8789 68.5566 74.8789 73.8039C74.8789 79.0513 79.1327 83.3051 84.3801 83.3051Z" fill="#EF2B58" />
                                    <path d="M84.4262 87.931C77.8117 87.8826 72.4076 93.2044 72.3594 99.8204L96.3174 99.9995C96.3672 93.3835 91.0422 87.9812 84.4262 87.931Z" fill="#EF2B58" />
                                    <path d="M53.2537 46.0293H42.802V38.2838C42.8535 31.4064 38.0496 25.6295 31.5982 24.1934L30.409 27.8789H26.5281L25.3422 24.1998C18.9746 25.623 14.1869 31.2676 14.1369 38.0691V46.0293H3.68359V52.5986H53.2537V46.0293ZM26.5281 29.9992H30.409V41.9355L28.4691 43.6137L26.5279 41.9355L26.5281 29.9992Z" fill="#EF2B58" />
                                </svg>

                            </MudItem>

                            <MudItem xs="8" Class="d-flex justify-center flex-column" Style="padding-top:0; padding-left:0; text-align:center; ">
                                <MudText Typo="Typo.h6">Tổng số lớp tham gia</MudText>
                                <MudText>@_totalClassed</MudText>
                            </MudItem>
                        </MudGrid>

                    </MudPaper>
                </MudItem>
                <MudItem xs="12" Class="h-100">
                    <MudTable Items="@_lstSubmitted" Dense="true" Hover="true" Virtualize="true" FixedHeader="true" HorizontalScrollbar="true" Height="515px">
                        <ToolBarContent>
                            <MudText Typo="Typo.h6">Kết quả bài thi</MudText>
                            <MudSpacer />
                            <MudTextField T="string" Placeholder="Search" Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
                        </ToolBarContent>
                        <HeaderContent>
                            <MudTh><MudTableSortLabel SortLabel="nr_field" T="string">Tên bài thi</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="sign_field" T="string">Ngày nộp</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="name_field" T="string">Môn</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="position_field" T="string">Điểm</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="position_field" T="string">Đạt</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="position_field" T="string">Ghi chú</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel SortLabel="mass_field" T="string">Thao tác</MudTableSortLabel></MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Nr">@context.Name</MudTd>
                            <MudTd DataLabel="Sign">@context.SubmitTime</MudTd>
                            <MudTd DataLabel="Name">@context.SubjectName</MudTd>
                            <MudTd DataLabel="Position">@context.TotalMark</MudTd>
                            <MudTd DataLabel="Molar mass">@(context.IsPassed?"Đạt":"Chưa đạt")</MudTd>
                            <MudTd DataLabel="Position">@context.Note</MudTd>
                            <MudTd DataLabel="Molar mass"><MudButton Variant="Variant.Outlined" Color="Color.Primary">Xem</MudButton></MudTd>
                        </RowTemplate>
                        <NoRecordsContent>
                            <MudText>Chưa có bài đã thi</MudText>
                        </NoRecordsContent>
                        <LoadingContent>
                            <MudText>Loading...</MudText>
                        </LoadingContent>
                        <PagerContent>
                            <MudTablePager />
                        </PagerContent>
                    </MudTable>
                </MudItem>
            </MudGrid>
        </MudItem>
    </MudGrid>
}

@code {
    private Guid _userId = Guid.Empty;
    private bool isLoading = true;
    private int _totalSubmitted = 0;
    private int _totalClassed = 0;
    private List<ListExamsOfStudent> _lstExam = new List<ListExamsOfStudent>();
    private List<SubmissionWithName> _lstSubmitted = new List<SubmissionWithName>();
    private List<Achievenment> _lstAchivenment = new List<Achievenment>();

    private async Task LoadData()
    {
        var a = await ProtectedSessionStore.GetAsync<string>("userLogin");
        _userId = Guid.Parse(a.Value);
        var lstExam = await _serLec.GetListExam(_userId);
        _lstExam = lstExam.Where(x => x.ExamScheduleStartTime >= DateTime.Now).ToList();
        _lstSubmitted = await _serSubmission.GetAllSubmittedByUser(_userId);
        _totalSubmitted = _lstSubmitted.Count();
        var lstClassByUserId = await _serClassUser.GetAllClassByUserId(_userId);
        _totalClassed = lstClassByUserId.Count();
        _lstAchivenment = await _serSubmission.GetAllAchievenment(_userId);
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            await LoadData();
            StateHasChanged();
        }
        catch
        {

        }
        finally
        {
            isLoading = false;
        }
    }
}